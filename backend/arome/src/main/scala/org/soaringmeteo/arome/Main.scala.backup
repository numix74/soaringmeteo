package org.soaringmeteo.arome

import org.slf4j.LoggerFactory
import java.time.{ZonedDateTime, ZoneOffset}
import scala.util.{Try, Success, Failure}

object Main {
  private val logger = LoggerFactory.getLogger(getClass)

  def main(args: Array[String]): Unit = {
    logger.info("üå™Ô∏è  AROME Pipeline Started")
    if (args.length < 2) {
      println("Usage: arome <gribDir> <outputDir>")
      System.exit(1)
    }
    val gribDir = os.Path(args(0))
    val outputBaseDir = os.Path(args(1))
    val dirName = gribDir.last
    val runDate = dirName.substring(0, 8)
    val runHour = dirName.substring(9, 11)
    val year = runDate.substring(0, 4)
    val month = runDate.substring(4, 6)
    val day = runDate.substring(6, 8)
    val initTime = ZonedDateTime.of(
      year.toInt, month.toInt, day.toInt,
      runHour.toInt, 0, 0, 0,
      ZoneOffset.UTC
    )
    logger.info(s"Input GRIB: $gribDir")
    logger.info(s"Output: $outputBaseDir")
    logger.info(s"Run time: $initTime")
    Try {
      processAromeRun(gribDir, outputBaseDir, initTime)
    } match {
      case Success(_) =>
        logger.info("‚úÖ AROME Pipeline Complete")
      case Failure(ex) =>
        logger.error("‚ùå AROME Pipeline Failed", ex)
        System.exit(1)
    }
  }

  private def processAromeRun(
    gribDir: os.Path,
    outputBaseDir: os.Path,
    initTime: ZonedDateTime
  ): Unit = {
    val zone = AromeZone.paysBasque
    val windsDir = gribDir / "winds_extracted"
    
    logger.info("Processing AROME groups...")
    val groups = Seq(
      ("00H06H", 0 to 6),
      ("07H12H", 7 to 12),
      ("13H18H", 13 to 18),
      ("19H24H", 19 to 24),
      ("25H30H", 25 to 30),
      ("31H36H", 31 to 36),
      ("37H42H", 37 to 42)
    )
    groups.foreach { case (groupName, hours) =>
      logger.info(s"Processing group $groupName...")
      val sp1File = gribDir / s"SP1_${groupName}.grib2"
      val sp2File = gribDir / s"SP2_${groupName}.grib2"
      val sp3File = gribDir / s"SP3_${groupName}.grib2"
      if (os.exists(sp1File) && os.exists(sp2File) && os.exists(sp3File)) {
        hours.foreach { hour =>
          val hourOffsetInGroup = hour - hours.head
          logger.info(s"  Processing hour $hour (offset $hourOffsetInGroup in group)...")
          val data = AromeGrib.fromGroupFiles(
            sp1File, sp2File, sp3File, windsDir,
            hourOffsetInGroup,
            zone
          )
          logger.info(s"    Grid: ${data.length}√ó${data.head.length} points")
          val mapsDir = outputBaseDir / "maps"
          Seq("thermals", "pblh", "wind", "cape").foreach { param =>
            val outputFile = mapsDir / f"${param}_h${hour}%03d.png"
            AromeMapGenerator.generateMap(data, zone, param, outputFile, hour)
          }
        }
      } else {
        logger.warn(s"Missing files for group $groupName (need SP1, SP2, SP3)")
      }
    }
    logger.info("All groups processed")
  }
}
